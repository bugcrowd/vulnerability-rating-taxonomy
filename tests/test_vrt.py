import utils
import unittest
import subprocess
import jsonschema


class TestVrt(unittest.TestCase):
    @unittest.skip('need to decide the best way to handle this')
    def test_changelog_updated(self):
        """
        Checks if CHANGELOG.md is being updated with the current commit
        and prompts the user if it isn't
        """
        p = subprocess.Popen('git diff HEAD --stat --staged CHANGELOG.md | wc -l', shell=True, stdout=subprocess.PIPE)
        out, err = p.communicate()
        self.assertGreater(int(out), 0, 'CHANGELOG.md not updated')

    def validate_schema(self, schema_file, data_file):
        schema = utils.get_json(schema_file)
        data = utils.get_json(data_file)
        jsonschema.Draft4Validator.check_schema(schema)
        error = jsonschema.exceptions.best_match(jsonschema.Draft4Validator(schema).iter_errors(data))
        if error:
            raise error

    def test_vrt_schema(self):
        self.validate_schema(utils.VRT_SCHEMA_FILENAME, utils.VRT_FILENAME)

    def test_cvss_v3_schema(self):
        self.validate_schema(utils.CVSS_V3_SCHEMA_FILENAME, utils.CVSS_V3_MAPPING_FILENAME)

    def test_cwe_schema(self):
        self.validate_schema(utils.CWE_SCHEMA_FILENAME, utils.CWE_MAPPING_FILENAME)

    def all_vrt_ids_have_mapping(self, mappping_filename, key):
        vrt = utils.get_json(utils.VRT_FILENAME)
        mapping = utils.get_json(mappping_filename)
        keyed_mapping = utils.key_by_id(mapping['content'])
        for vrt_id_list in utils.all_id_lists(vrt, include_internal=False):
            self.assertTrue(utils.has_mapping(keyed_mapping, vrt_id_list, key),
                                'no ' + key + ' mapping for ' + '.'.join(vrt_id_list))

    def test_all_vrt_ids_have_cvss_v3_mapping(self):
        self.all_vrt_ids_have_mapping(utils.CVSS_V3_MAPPING_FILENAME, 'cvss_v3')

    def test_all_vrt_ids_have_cwe_mapping(self):
        self.all_vrt_ids_have_mapping(utils.CWE_MAPPING_FILENAME, 'cwe')

    def only_map_valid_ids(self, mappping_filename):
        vrt_ids = utils.all_id_lists(utils.get_json(utils.VRT_FILENAME))
        mapping_ids = utils.all_id_lists(utils.get_json(mappping_filename))
        for id_list in mapping_ids:
            self.assertIn(id_list, vrt_ids, 'invalid id in ' + mappping_filename + ' - ' + '.'.join(id_list))

    def test_only_map_valid_ids_cvss_v3(self):
        self.only_map_valid_ids(utils.CVSS_V3_MAPPING_FILENAME)

    def test_only_map_valid_ids_cwe(self):
        self.only_map_valid_ids(utils.CWE_MAPPING_FILENAME)


if __name__ == '__main__':
    unittest.main()
